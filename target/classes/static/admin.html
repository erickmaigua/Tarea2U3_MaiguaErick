<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administrativo - Zapatería</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="/css/style-admin.css">
</head>

<body>
    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2>
                <i data-lucide="shield"></i>
                Panel Admin
            </h2>
            <p>Sistema de Gestión</p>
        </div>

        <div class="user-info">
            <h3>
                <i data-lucide="user"></i>
                <span id="userName">Administrador</span>
            </h3>
            <span class="user-role">ADMINISTRADOR</span>
        </div>

        <nav class="menu">
            <div class="menu-item active" onclick="showSection('dashboard')">
                <i data-lucide="layout-dashboard"></i>
                <span>Dashboard</span>
            </div>
            <div class="menu-item" onclick="showSection('productos')" id="menuProductos">
                <i data-lucide="package"></i>
                <span>Productos</span>
            </div>
            <div class="menu-item" onclick="showSection('pedidos')">
                <i data-lucide="shopping-cart"></i>
                <span>Pedidos</span>
            </div>
            <div class="menu-item" onclick="showSection('clientes')">
                <i data-lucide="users"></i>
                <span>Clientes</span>
            </div>
            <div class="menu-item" onclick="showSection('usuarios')" id="menuUsuarios">
                <i data-lucide="user-cog"></i>
                <span>Usuarios</span>
            </div>
        </nav>

        <button class="logout-btn" onclick="logout()">
            <i data-lucide="log-out"></i>
            Cerrar Sesión
        </button>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <div id="alertContainer"></div>

        <!-- DASHBOARD -->
        <section id="dashboard" class="section active">
            <div class="page-header">
                <h1>
                    <i data-lucide="layout-dashboard"></i>
                    Dashboard
                </h1>
                <p>Vista general del sistema</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: #dbeafe; color: #1e40af">
                        <i data-lucide="package"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Total Productos</h3>
                        <p id="statProductos">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #d1fae5; color: #065f46">
                        <i data-lucide="users"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Total Clientes</h3>
                        <p id="statClientes">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #fef3c7; color: #92400e">
                        <i data-lucide="shopping-cart"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Pedidos Pendientes</h3>
                        <p id="statPedidos">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #fee2e2; color: #991b1b">
                        <i data-lucide="alert-triangle"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Stock Bajo</h3>
                        <p id="statStockBajo">0</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- PRODUCTOS -->
        <section id="productos" class="section">
            <div class="page-header">
                <h1>
                    <i data-lucide="package"></i>
                    Gestión de Productos
                </h1>
                <p>Administra tu inventario</p>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>
                        <i data-lucide="plus-circle"></i>
                        <span id="formTitle">Agregar Nuevo Producto</span>
                    </h2>
                </div>
                <form id="productoForm" onsubmit="guardarProducto(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>
                                <i data-lucide="hash"></i>
                                Código
                            </label>
                            <input type="text" id="prodCodigo" placeholder="ZAP001" required>
                        </div>
                        <div class="form-group">
                            <label>
                                <i data-lucide="tag"></i>
                                Nombre
                            </label>
                            <input type="text" id="prodNombre" placeholder="Nike Air Max" required>
                        </div>
                        <div class="form-group">
                            <label>
                                <i data-lucide="award"></i>
                                Marca
                            </label>
                            <input type="text" id="prodMarca" placeholder="Nike" required>
                        </div>
                        <div class="form-group">
                            <label>
                                <i data-lucide="folder"></i>
                                Categoría
                            </label>
                            <select id="prodCategoria" required>
                                <option value="deportivo">Deportivo</option>
                                <option value="casual">Casual</option>
                                <option value="formal">Formal</option>
                                <option value="running">Running</option>
                                <option value="urbano">Urbano</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>
                                <i data-lucide="ruler"></i>
                                Talla
                            </label>
                            <input type="text" id="prodTalla" placeholder="42" required>
                        </div>
                        <div class="form-group">
                            <label>
                                <i data-lucide="palette"></i>
                                Color
                            </label>
                            <input type="text" id="prodColor" placeholder="Negro" required>
                        </div>
                        <div class="form-group">
                            <label>
                                <i data-lucide="dollar-sign"></i>
                                Precio
                            </label>
                            <input type="number" id="prodPrecio" placeholder="89.99" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>
                                <i data-lucide="package"></i>
                                Stock
                            </label>
                            <input type="number" id="prodStock" placeholder="50" required>
                        </div>
                        <div class="form-group">
                            <label>
                                <i data-lucide="image"></i>
                                Imagen del Producto
                            </label>
                            <input type="file" id="prodImagen" accept="image/*" onchange="previewImage(this)">
                            <div id="imagePreview" style="margin-top: 10px; display: none;">
                                <img id="previewImg"
                                    style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid #e5e7eb;">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>
                            <i data-lucide="file-text"></i>
                            Descripción
                        </label>
                        <textarea id="prodDescripcion" rows="3" placeholder="Descripción detallada..."
                            required></textarea>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i data-lucide="save"></i>
                        <span id="btnSubmitText">Guardar Producto</span>
                    </button>
                    <button type="button" class="btn btn-danger" id="btnCancelar" style="display:none;"
                        onclick="cancelarEdicion()">
                        <i data-lucide="x"></i>
                        Cancelar
                    </button>
                </form>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>
                        <i data-lucide="list"></i>
                        Lista de Productos
                    </h2>
                    <button class="btn btn-primary btn-sm" onclick="cargarProductos()">
                        <i data-lucide="refresh-cw"></i>
                        Actualizar
                    </button>
                </div>
                <div class="table-container">
                    <table id="tablaProductos">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Nombre</th>
                                <th>Marca</th>
                                <th>Categoría</th>
                                <th>Talla</th>
                                <th>Precio</th>
                                <th>Stock</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- PEDIDOS -->
        <section id="pedidos" class="section">
            <div class="page-header">
                <h1>
                    <i data-lucide="shopping-cart"></i>
                    Gestión de Pedidos
                </h1>
                <p>Administra las órdenes de compra</p>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>
                        <i data-lucide="list"></i>
                        Lista de Pedidos
                    </h2>
                    <button class="btn btn-primary btn-sm" onclick="cargarPedidos()">
                        <i data-lucide="refresh-cw"></i>
                        Actualizar
                    </button>
                </div>
                <div class="table-container">
                    <table id="tablaPedidos">
                        <thead>
                            <tr>
                                <th>Número</th>
                                <th>Cliente</th>
                                <th>Items</th>
                                <th>Total</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- CLIENTES -->
        <section id="clientes" class="section">
            <div class="page-header">
                <h1>
                    <i data-lucide="users"></i>
                    Gestión de Clientes
                </h1>
                <p>Usuarios registrados en el sistema</p>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>
                        <i data-lucide="list"></i>
                        Lista de Clientes
                    </h2>
                    <button class="btn btn-primary btn-sm" onclick="cargarClientes()">
                        <i data-lucide="refresh-cw"></i>
                        Actualizar
                    </button>
                </div>
                <div class="table-container">
                    <table id="tablaClientes">
                        <thead>
                            <tr>
                                <th>Nombre Completo</th>
                                <th>Email</th>
                                <th>Teléfono</th>
                                <th>Dirección</th>
                                <th>Empleado Asignado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- USUARIOS (Solo ADMINISTRADOR) -->
        <section id="usuarios" class="section">
            <div class="card-header">
                <h2>
                    <i data-lucide="users"></i>
                    Lista de Usuarios (Empleados y Administradores)
                </h2>
                <button class="btn btn-primary btn-sm" onclick="cargarEmpleados()">
                    <i data-lucide="refresh-cw"></i>
                    Actualizar
                </button>
            </div>

            <!-- Formulario de registro -->
            <div class="card">
                <div class="card-header">
                    <h2>
                        <i data-lucide="user-plus"></i>
                        Registrar Nuevo Usuario
                    </h2>
                </div>
                <form id="usuarioForm" onsubmit="registrarUsuario(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>
                                <i data-lucide="user"></i>
                                Nombre
                            </label>
                            <input type="text" id="usuNombre" placeholder="Juan" required>
                        </div>
                        <div class="form-group">
                            <label>
                                <i data-lucide="user"></i>
                                Apellido
                            </label>
                            <input type="text" id="usuApellido" placeholder="Pérez" required>
                        </div>
                        <div class="form-group">
                            <label>
                                <i data-lucide="mail"></i>
                                Email
                            </label>
                            <input type="email" id="usuEmail" placeholder="correo@ejemplo.com" required>
                        </div>
                        <div class="form-group">
                            <label>
                                <i data-lucide="phone"></i>
                                Teléfono
                            </label>
                            <input type="text" id="usuTelefono" placeholder="0991234567">
                        </div>
                        <div class="form-group">
                            <label>
                                <i data-lucide="user-check"></i>
                                Usuario
                            </label>
                            <input type="text" id="usuUsername" placeholder="usuario123" required>
                        </div>
                        <div class="form-group">
                            <label>
                                <i data-lucide="lock"></i>
                                Contraseña
                            </label>
                            <input type="password" id="usuPassword" placeholder="Contraseña segura" required>
                        </div>
                        <div class="form-group">
                            <label>
                                <i data-lucide="shield"></i>
                                Rol
                            </label>
                            <select id="usuRol" required>
                                <option value="EMPLEADO">Empleado (Ventas)</option>
                                <option value="DESPACHO">Empleado (Despacho)</option>
                                <option value="ADMINISTRADOR">Administrador</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i data-lucide="save"></i>
                        Registrar Usuario
                    </button>
                </form>
            </div>

            <!-- Lista de empleados -->
            <div class="card">
                <div class="card-header">
                    <h2>
                        <i data-lucide="users"></i>
                        Lista de Usuarios
                    </h2>
                    <button class="btn btn-primary btn-sm" onclick="cargarEmpleados()">
                        <i data-lucide="refresh-cw"></i>
                        Actualizar
                    </button>
                </div>
                <div class="table-container">
                    <table id="tablaEmpleados">
                        <thead>
                            <tr>
                                <th>Nombre Completo</th>
                                <th>Email</th>
                                <th>Teléfono</th>
                                <th>Usuario</th>
                                <th>Clientes Asignados</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <script>
        const API_URL = 'http://localhost:8080/api';
        let productoEditando = null;

        // Verificar sesión
        let currentUserRole = '';

        function checkSession() {
            const user = sessionStorage.getItem('currentUser');
            if (!user) {
                window.location.href = 'login-admin.html';
                return;
            }

            const currentUser = JSON.parse(user);
            currentUserRole = currentUser.rol;

            if (currentUser.rol !== 'ADMINISTRADOR' && currentUser.rol !== 'EMPLEADO' && currentUser.rol !== 'DESPACHO') {
                alert('Acceso denegado');
                window.location.href = 'login-cliente.html';
                return;
            }

            // Mostrar nombre y rol
            document.getElementById('userName').textContent = currentUser.nombre;
            document.querySelector('.user-role').textContent = currentUser.rol;

            // Ocultar opciones según rol
            if (currentUser.rol === 'EMPLEADO') {
                document.getElementById('menuUsuarios').style.display = 'none';
            }

            if (currentUser.rol === 'DESPACHO') {
                // Solo puede ver pedidos
                document.getElementById('menuProductos').style.display = 'none';
                document.getElementById('menuUsuarios').style.display = 'none';
                document.querySelector('.menu-item[onclick*="clientes"]').style.display = 'none';
                document.querySelector('.menu-item[onclick*="dashboard"]').style.display = 'none';
            }

            loadDashboardData();
        }

        // Mostrar sección
        function showSection(sectionId) {
            // Validar acceso según rol
            if (currentUserRole === 'EMPLEADO' && sectionId === 'usuarios') {
                showAlert('No tiene permisos para acceder a esta sección', 'error');
                return;
            }

            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            switch (sectionId) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'productos':
                    cargarProductos();
                    break;
                case 'pedidos':
                    cargarPedidos();
                    break;
                case 'clientes':
                    cargarClientes();
                    break;
                case 'usuarios':
                    cargarEmpleados();
                    break;
            }

            lucide.createIcons();
        }

        // Dashboard
        async function loadDashboardData() {
            try {
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));

                const [productos, pedidos, clientes] = await Promise.all([
                    fetch(`${API_URL}/productos`).then(r => r.json()),
                    fetch(`${API_URL}/pedidos/mis-pedidos/${currentUser.id}`).then(r => r.json()),
                    fetch(`${API_URL}/usuarios/mis-clientes/${currentUser.id}`).then(r => r.json())
                ]);

                document.getElementById('statProductos').textContent = productos.length;
                document.getElementById('statClientes').textContent = clientes.length;

                const pedidosPendientes = pedidos.filter(p =>
                    p.estado === 'PENDIENTE' || p.estado === 'PROCESANDO'
                ).length;
                document.getElementById('statPedidos').textContent = pedidosPendientes;

                const stockBajo = productos.filter(p => p.stock < 10).length;
                document.getElementById('statStockBajo').textContent = stockBajo;
            } catch (error) {
                console.error('Error cargando dashboard:', error);
            }
        }

        // PRODUCTOS
        async function cargarProductos() {
            try {

                const formCard = document.querySelector('#productos .card:first-child');
                if (currentUserRole === 'EMPLEADO') {
                    if (formCard) formCard.style.display = 'none';
                } else {
                    if (formCard) formCard.style.display = 'block';
                }

                const response = await fetch(`${API_URL}/productos`);
                const productos = await response.json();

                const tbody = document.querySelector('#tablaProductos tbody');
                tbody.innerHTML = '';

                if (productos.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px; color: #999;">No hay productos registrados</td></tr>';
                    return;
                }

                productos.forEach(prod => {
                    const stockClass = prod.stock < 10 ? 'badge-danger' : prod.stock < 30 ? 'badge-warning' : 'badge-success';

                    const botonesAccion = currentUserRole === 'ADMINISTRADOR' ? `
                        <button class="btn btn-warning btn-sm" onclick="editarProductoInline('${prod.id}')" style="margin-right: 5px;">
                            <i data-lucide="edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="eliminarProducto('${prod.id}')">
                            <i data-lucide="trash-2"></i>
                        </button>
                    ` : '<span style="color: #999;">Solo lectura</span>';

                   tbody.innerHTML += `
                        <tr id="prod-row-${prod.id}">
                            <td>
                                ${prod.imagen ? `<img src="${prod.imagen}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; margin-right: 8px; vertical-align: middle;">` : ''}
                                <strong><span class="view-mode">${prod.codigo}</span></strong>
                            </td>
                            <td><span class="view-mode">${prod.nombre}</span></td>
                            <td><span class="view-mode">${prod.marca}</span></td>
                            <td><span class="view-mode badge badge-info">${prod.categoria}</span></td>
                            <td><span class="view-mode">${prod.talla}</span></td>
                            <td><strong><span class="view-mode">$${prod.precio.toFixed(2)}</span></strong></td>
                            <td><span class="view-mode badge ${stockClass}">${prod.stock}</span></td>
                            <td>${botonesAccion}</td>
                        </tr>
                    `;
                });

                lucide.createIcons();
            } catch (error) {
                showAlert('Error al cargar productos', 'error');
            }
        }

        // Preview de imagen
        function previewImage(input) {
            const preview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');

            if (input.files && input.files[0]) {
                const reader = new FileReader();

                reader.onload = function (e) {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                };

                reader.readAsDataURL(input.files[0]);
            } else {
                preview.style.display = 'none';
            }
        }

        // Convertir imagen a base64
        function getBase64Image() {
            return new Promise((resolve, reject) => {
                const fileInput = document.getElementById('prodImagen');

                if (!fileInput.files || !fileInput.files[0]) {
                    resolve(null);
                    return;
                }

                const file = fileInput.files[0];

                // Validar tamaño (max 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    reject('La imagen no debe superar 2MB');
                    return;
                }

                // Validar tipo
                if (!file.type.startsWith('image/')) {
                    reject('Solo se permiten archivos de imagen');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    resolve(e.target.result);
                };
                reader.onerror = function () {
                    reject('Error al leer la imagen');
                };
                reader.readAsDataURL(file);
            });
        }

        async function guardarProducto(e) {
            e.preventDefault();

            // Validación de campos
            const codigo = document.getElementById('prodCodigo').value.trim();
            const nombre = document.getElementById('prodNombre').value.trim();
            const marca = document.getElementById('prodMarca').value.trim();
            const precio = parseFloat(document.getElementById('prodPrecio').value);
            const stock = parseInt(document.getElementById('prodStock').value);

            if (!codigo || !nombre || !marca) {
                showAlert('Código, nombre y marca son obligatorios', 'warning');
                return;
            }

            if (isNaN(precio) || precio <= 0) {
                showAlert('El precio debe ser mayor a 0', 'warning');
                return;
            }

            if (isNaN(stock) || stock < 0) {
                showAlert('El stock no puede ser negativo', 'warning');
                return;
            }

            try {
                // Obtener imagen en base64
                const imagenBase64 = await getBase64Image();

                const producto = {
                    codigo: codigo,
                    nombre: nombre,
                    descripcion: document.getElementById('prodDescripcion').value.trim(),
                    marca: marca,
                    categoria: document.getElementById('prodCategoria').value,
                    talla: document.getElementById('prodTalla').value.trim(),
                    color: document.getElementById('prodColor').value.trim(),
                    precio: precio,
                    stock: stock,
                    imagen: imagenBase64
                };

                let response;
                if (productoEditando) {
                    response = await fetch(`${API_URL}/productos/${productoEditando}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(producto)
                    });
                } else {
                    response = await fetch(`${API_URL}/productos`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(producto)
                    });
                }

                if (response.ok) {
                    showAlert(productoEditando ? 'Producto actualizado' : 'Producto creado', 'success');
                    e.target.reset();
                    document.getElementById('imagePreview').style.display = 'none';
                    cancelarEdicion();
                    cargarProductos();
                    loadDashboardData();
                }
            } catch (error) {
                if (typeof error === 'string') {
                    showAlert(error, 'error');
                } else {
                    showAlert('Error al guardar producto', 'error');
                }
            }
        }
        async function editarProducto(id) {
            try {
                const response = await fetch(`${API_URL}/productos/${id}`);
                const prod = await response.json();

                productoEditando = id;

                document.getElementById('prodCodigo').value = prod.codigo;
                document.getElementById('prodNombre').value = prod.nombre;
                document.getElementById('prodDescripcion').value = prod.descripcion;
                document.getElementById('prodMarca').value = prod.marca;
                document.getElementById('prodCategoria').value = prod.categoria;
                document.getElementById('prodTalla').value = prod.talla;
                document.getElementById('prodColor').value = prod.color;
                document.getElementById('prodPrecio').value = prod.precio;
                document.getElementById('prodStock').value = prod.stock;

                // Mostrar imagen existente si hay
                if (prod.imagen) {
                    document.getElementById('previewImg').src = prod.imagen;
                    document.getElementById('imagePreview').style.display = 'block';
                } else {
                    document.getElementById('imagePreview').style.display = 'none';
                }

                document.getElementById('formTitle').textContent = 'Editar Producto';
                document.getElementById('btnSubmitText').textContent = 'Actualizar Producto';
                document.getElementById('btnCancelar').style.display = 'inline-flex';

                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                showAlert('Error al cargar producto', 'error');
            }
        }

        function cancelarEdicion() {
            productoEditando = null;
            document.getElementById('productoForm').reset();
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('formTitle').textContent = 'Agregar Nuevo Producto';
            document.getElementById('btnSubmitText').textContent = 'Guardar Producto';
            document.getElementById('btnCancelar').style.display = 'none';
        }

        async function eliminarProducto(id) {
            if (!confirm('¿Está seguro de eliminar este producto?')) return;

            try {
                await fetch(`${API_URL}/productos/${id}`, { method: 'DELETE' });
                showAlert('Producto eliminado', 'success');
                cargarProductos();
                loadDashboardData();
            } catch (error) {
                showAlert('Error al eliminar producto', 'error');
            }
        }

        async function editarProductoInline(id) {
            try {
                const response = await fetch(`${API_URL}/productos/${id}`);
                const prod = await response.json();

                const row = document.getElementById(`prod-row-${id}`);

                row.innerHTML = `
            <td><input type="text" id="edit-codigo-${id}" value="${prod.codigo}" class="form-control-inline"></td>
            <td><input type="text" id="edit-nombre-${id}" value="${prod.nombre}" class="form-control-inline"></td>
            <td><input type="text" id="edit-marca-${id}" value="${prod.marca}" class="form-control-inline"></td>
            <td>
                <select id="edit-categoria-${id}" class="form-control-inline">
                    <option value="deportivo" ${prod.categoria === 'deportivo' ? 'selected' : ''}>Deportivo</option>
                    <option value="casual" ${prod.categoria === 'casual' ? 'selected' : ''}>Casual</option>
                    <option value="formal" ${prod.categoria === 'formal' ? 'selected' : ''}>Formal</option>
                    <option value="running" ${prod.categoria === 'running' ? 'selected' : ''}>Running</option>
                    <option value="urbano" ${prod.categoria === 'urbano' ? 'selected' : ''}>Urbano</option>
                </select>
            </td>
            <td><input type="text" id="edit-talla-${id}" value="${prod.talla}" class="form-control-inline" style="width: 60px;"></td>
            <td><input type="number" id="edit-precio-${id}" value="${prod.precio}" step="0.01" class="form-control-inline" style="width: 80px;"></td>
            <td><input type="number" id="edit-stock-${id}" value="${prod.stock}" class="form-control-inline" style="width: 60px;"></td>
            <td>
                <button class="btn btn-success btn-sm" onclick="guardarProductoInline('${id}')" style="margin-right: 5px;">
                    <i data-lucide="check"></i>
                </button>
                <button class="btn btn-danger btn-sm" onclick="cargarProductos()">
                    <i data-lucide="x"></i>
                </button>
            </td>
        `;

                lucide.createIcons();
            } catch (error) {
                showAlert('Error al cargar producto', 'error');
            }
        }

        async function guardarProductoInline(id) {
            const producto = {
                codigo: document.getElementById(`edit-codigo-${id}`).value,
                nombre: document.getElementById(`edit-nombre-${id}`).value,
                marca: document.getElementById(`edit-marca-${id}`).value,
                categoria: document.getElementById(`edit-categoria-${id}`).value,
                talla: document.getElementById(`edit-talla-${id}`).value,
                precio: parseFloat(document.getElementById(`edit-precio-${id}`).value),
                stock: parseInt(document.getElementById(`edit-stock-${id}`).value)
            };

            try {
                const response = await fetch(`${API_URL}/productos/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(producto)
                });

                if (response.ok) {
                    showAlert('Producto actualizado correctamente', 'success');
                    cargarProductos();
                    loadDashboardData();
                }
            } catch (error) {
                showAlert('Error al actualizar producto', 'error');
            }
        }

		// PEDIDOS
		async function cargarPedidos() {
		    try {
		        const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
		        let url = `${API_URL}/pedidos/mis-pedidos/${currentUser.id}`;

		        // Si es DESPACHO, solo mostrar pedidos procesados
		        if (currentUserRole === 'DESPACHO') {
		            url = `${API_URL}/pedidos/procesados`;
		        }

		        const response = await fetch(url);
		        const pedidos = await response.json();

		        const tbody = document.querySelector('#tablaPedidos tbody');
		        tbody.innerHTML = '';

		        if (pedidos.length === 0) {
		            let mensaje = 'No hay pedidos registrados';
		            if (currentUserRole === 'EMPLEADO') mensaje = 'No hay pedidos de tus clientes asignados';
		            if (currentUserRole === 'DESPACHO') mensaje = 'No hay pedidos procesados para despachar';

		            tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 30px; color: #999;">${mensaje}</td></tr>`;
		            return;
		        }

		        pedidos.forEach(ped => {
		            const estadoBadge = {
		                'PENDIENTE': 'badge-warning',
		                'PROCESANDO': 'badge-info',
		                'ENTREGADO': 'badge-success'
		            }[ped.estado] || 'badge-info';

		            const empleadoInfo = currentUserRole === 'ADMINISTRADOR' && ped.empleadoAsignadoNombre ?
		                `<br><small style="color: #666;">Asignado a: ${ped.empleadoAsignadoNombre}</small>` : '';

		            // Botones según rol
		            let botonesAccion = '';
		            if (currentUserRole === 'EMPLEADO' && ped.estado === 'PENDIENTE') {
		                botonesAccion = `
		                    <button class="btn btn-info btn-sm" onclick="verDetallePedido('${ped.id}')" style="margin-right: 5px;">
		                        <i data-lucide="eye"></i>
		                    </button>
		                    <button class="btn btn-success btn-sm" onclick="marcarProcesado('${ped.id}')">
		                        <i data-lucide="check"></i> Procesar
		                    </button>
		                `;
		            } else if (currentUserRole === 'DESPACHO' && ped.estado === 'PROCESANDO') {
		                botonesAccion = `
		                    <button class="btn btn-info btn-sm" onclick="verDetallePedido('${ped.id}')" style="margin-right: 5px;">
		                        <i data-lucide="eye"></i>
		                    </button>
		                    <button class="btn btn-success btn-sm" onclick="marcarEntregado('${ped.id}')">
		                        <i data-lucide="truck"></i> Entregar
		                    </button>
		                `;
		            } else if (currentUserRole === 'ADMINISTRADOR') {
		                // Administrador puede ver y cambiar cualquier estado
		                let botonesEstado = '';
		                if (ped.estado === 'PENDIENTE') {
		                    botonesEstado = `
		                        <button class="btn btn-success btn-sm" onclick="marcarProcesado('${ped.id}')" style="margin-left: 5px;">
		                            <i data-lucide="check"></i> Procesar
		                        </button>
		                    `;
		                } else if (ped.estado === 'PROCESANDO') {
		                    botonesEstado = `
		                        <button class="btn btn-success btn-sm" onclick="marcarEntregado('${ped.id}')" style="margin-left: 5px;">
		                            <i data-lucide="truck"></i> Entregar
		                        </button>
		                    `;
		                }

		                botonesAccion = `
		                    <button class="btn btn-info btn-sm" onclick="verDetallePedido('${ped.id}')">
		                        <i data-lucide="eye"></i>
		                    </button>
		                    ${botonesEstado}
		                `;
		            } else {
		                botonesAccion = `
		                    <button class="btn btn-info btn-sm" onclick="verDetallePedido('${ped.id}')">
		                        <i data-lucide="eye"></i>
		                    </button>
		                `;
		            }

		            // ➕ Botón de FACTURA solo si el pedido está ENTREGADO (para cualquier rol interno)
		            if (ped.estado === 'ENTREGADO') {
		                botonesAccion += `
		                    <button class="btn btn-warning btn-sm" onclick="descargarFactura('${ped.id}')" style="margin-left: 5px;">
		                        <i data-lucide="file-text"></i> Factura
		                    </button>
		                `;
		            }

		            tbody.innerHTML += `
		                <tr>
		                    <td><strong>${ped.numeroPedido}</strong></td>
		                    <td>${ped.clienteNombre}${empleadoInfo}</td>
		                    <td>${ped.items ? ped.items.length : 0} items</td>
		                    <td><strong>$${ped.total.toFixed(2)}</strong></td>
		                    <td><span class="badge ${estadoBadge}">${ped.estado}</span></td>
		                    <td>${new Date(ped.fecha).toLocaleDateString('es-ES')}</td>
		                    <td>${botonesAccion}</td>
		                </tr>
		            `;
		        });

		        lucide.createIcons();
		    } catch (error) {
		        showAlert('Error al cargar pedidos', 'error');
		    }
		}


        // Ver detalle del pedido
        async function verDetallePedido(pedidoId) {
            try {
                const response = await fetch(`${API_URL}/pedidos/${pedidoId}`);
                const pedido = await response.json();

                const itemsHtml = pedido.items.map(item => `
            <div style="padding: 10px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between;">
                <div>
                    <strong>${item.nombreProducto}</strong><br>
                    <small>Cantidad: ${item.cantidad} x $${item.precio.toFixed(2)}</small>
                </div>
                <strong>$${(item.cantidad * item.precio).toFixed(2)}</strong>
            </div>
        `).join('');

                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2>
                        <i data-lucide="shopping-cart"></i>
                        Detalle del Pedido ${pedido.numeroPedido}
                    </h2>
                    <button class="close-modal" onclick="this.closest('.modal').remove()">
                        <i data-lucide="x" style="width: 28px; height: 28px;"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div style="margin-bottom: 20px;">
                        <p><strong>Cliente:</strong> ${pedido.clienteNombre}</p>
                        <p><strong>Estado:</strong> <span class="badge badge-info">${pedido.estado}</span></p>
                        <p><strong>Fecha:</strong> ${new Date(pedido.fecha).toLocaleDateString('es-ES')}</p>
                        ${pedido.empleadoAsignadoNombre ? `<p><strong>Empleado:</strong> ${pedido.empleadoAsignadoNombre}</p>` : ''}
                    </div>
                    
                    <h3 style="margin-bottom: 15px;">Items del Pedido</h3>
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                        ${itemsHtml}
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f9fafb; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; font-size: 18px;">
                            <strong>Total:</strong>
                            <strong style="color: #059669;">$${pedido.total.toFixed(2)}</strong>
                        </div>
                    </div>
                </div>
            </div>
        `;

                document.body.appendChild(modal);
                lucide.createIcons();

                // Cerrar modal al hacer clic fuera
                modal.onclick = function (event) {
                    if (event.target === modal) {
                        modal.remove();
                    }
                };
            } catch (error) {
                showAlert('Error al cargar detalle del pedido', 'error');
            }
        }

        // Marcar pedido como procesado (EMPLEADO)
        async function marcarProcesado(pedidoId) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>
                    <i data-lucide="check-circle"></i>
                    Confirmar Procesamiento
                </h2>
                <button class="close-modal" onclick="this.closest('.modal').remove()">
                    <i data-lucide="x" style="width: 28px; height: 28px;"></i>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; text-align: center;">¿Desea marcar este pedido como PROCESADO?</p>
                <div style="display: flex; gap: 10px; justify-content: center; align-items: center; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="confirmarCambioEstado('${pedidoId}', 'PROCESANDO')" style="min-width: 120px;">
                        <i data-lucide="check"></i>
                        Confirmar
                    </button>
                    <button class="btn btn-danger" onclick="this.closest('.modal').remove()" style="min-width: 120px;">
                        <i data-lucide="x"></i>
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    `;

            document.body.appendChild(modal);
            lucide.createIcons();
        }

        // Marcar pedido como entregado (DESPACHO)
        async function marcarEntregado(pedidoId) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>
                    <i data-lucide="truck"></i>
                    Confirmar Entrega
                </h2>
                <button class="close-modal" onclick="this.closest('.modal').remove()">
                    <i data-lucide="x" style="width: 28px; height: 28px;"></i>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px;">¿Desea marcar este pedido como ENTREGADO?</p>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="confirmarCambioEstado('${pedidoId}', 'ENTREGADO')">
                        <i data-lucide="check"></i>
                        Confirmar
                    </button>
                    <button class="btn btn-danger" onclick="this.closest('.modal').remove()">
                        <i data-lucide="x"></i>
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    `;

            document.body.appendChild(modal);
            lucide.createIcons();
        }

        // Confirmar cambio de estado
        async function confirmarCambioEstado(pedidoId, nuevoEstado) {
            try {
                await fetch(`${API_URL}/pedidos/${pedidoId}/estado`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ estado: nuevoEstado })
                });

                showAlert('Estado actualizado correctamente', 'success');
                document.querySelectorAll('.modal').forEach(m => m.remove());
                cargarPedidos();
                loadDashboardData();
            } catch (error) {
                showAlert('Error al actualizar estado', 'error');
            }
        }
		async function descargarFactura(pedidoId) {
		    try {
		        const response = await fetch(`${API_URL}/facturas/pedido/${pedidoId}`);

		        if (!response.ok) {
		            showAlert('Error al generar la factura', 'error');
		            return;
		        }

		        const blob = await response.blob();
		        const url = window.URL.createObjectURL(blob);

		        const a = document.createElement('a');
		        a.href = url;
		        a.download = `factura-pedido-${pedidoId}.pdf`;
		        document.body.appendChild(a);
		        a.click();
		        a.remove();

		        window.URL.revokeObjectURL(url);
		        showAlert('Factura descargada correctamente', 'success');
		    } catch (error) {
		        console.error(error);
		        showAlert('Error al descargar la factura', 'error');
		    }
		}


        // CLIENTES
        async function cargarClientes() {
            try {
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
                const url = `${API_URL}/usuarios/mis-clientes/${currentUser.id}`;

                const [clientesRes, empleadosRes] = await Promise.all([
                    fetch(url),
                    fetch(`${API_URL}/usuarios/empleados`)
                ]);

                const clientes = await clientesRes.json();
                const empleados = await empleadosRes.json();

                const tbody = document.querySelector('#tablaClientes tbody');
                tbody.innerHTML = '';

                if (clientes.length === 0) {
                    const mensaje = currentUserRole === 'EMPLEADO' ?
                        'No tienes clientes asignados' :
                        'No hay clientes registrados';
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 30px; color: #999;">${mensaje}</td></tr>`;
                    return;
                }

                clientes.forEach(cli => {
                    const empleadoAsignado = empleados.find(e => e.id === cli.empleadoAsignadoId);
                    const empleadoNombre = empleadoAsignado ?
                        `${empleadoAsignado.nombre} ${empleadoAsignado.apellido}` :
                        '<span style="color: #999;">Sin asignar</span>';

                    const accionesBtn = `
                <button class="btn btn-warning btn-sm" onclick="editarClienteInline('${cli.id}')" style="margin-right: 5px;">
                    <i data-lucide="edit"></i>
                </button>
                ${currentUserRole === 'ADMINISTRADOR' ?
                            `<button class="btn btn-danger btn-sm" onclick="eliminarCliente('${cli.id}')">
                        <i data-lucide="trash-2"></i>
                    </button>` : ''}
            `;

                    tbody.innerHTML += `
                <tr id="cliente-row-${cli.id}">
                    <td><strong><span class="view-mode">${cli.nombre} ${cli.apellido || ''}</span></strong></td>
                    <td><span class="view-mode">${cli.email}</span></td>
                    <td><span class="view-mode">${cli.telefono || 'N/A'}</span></td>
                    <td><span class="view-mode">${cli.direccion || 'N/A'}</span></td>
                    <td id="empleado-cell-${cli.id}">${empleadoNombre}</td>
                    <td>${accionesBtn}</td>
                </tr>
            `;
                });

                lucide.createIcons();
            } catch (error) {
                showAlert('Error al cargar clientes', 'error');
            }
        }

        async function editarClienteInline(id) {
            try {
                const response = await fetch(`${API_URL}/usuarios/${id}`);
                const cli = await response.json();

                const row = document.getElementById(`cliente-row-${id}`);
                const empleadoCell = document.getElementById(`empleado-cell-${id}`);

                // Obtener empleados para el select
                let empleadosSelect = '';
                if (currentUserRole === 'ADMINISTRADOR') {
                    const empRes = await fetch(`${API_URL}/usuarios/empleados`);
                    const empleados = await empRes.json();

                    empleadosSelect = `<select id="edit-empleado-${id}" class="form-control-inline">
                <option value="">Sin asignar</option>
                ${empleados.map(e =>
                        `<option value="${e.id}" ${cli.empleadoAsignadoId === e.id ? 'selected' : ''}>
                        ${e.nombre} ${e.apellido}
                    </option>`
                    ).join('')}
            </select>`;
                } else {
                    empleadosSelect = empleadoCell.innerHTML;
                }

                row.innerHTML = `
            <td>
                <input type="text" id="edit-nombre-${id}" value="${cli.nombre}" class="form-control-inline" style="width: 100px;">
                <input type="text" id="edit-apellido-${id}" value="${cli.apellido || ''}" class="form-control-inline" style="width: 100px;">
            </td>
            <td><input type="email" id="edit-email-${id}" value="${cli.email}" class="form-control-inline"></td>
            <td><input type="text" id="edit-telefono-${id}" value="${cli.telefono || ''}" class="form-control-inline" style="width: 100px;"></td>
            <td><input type="text" id="edit-direccion-${id}" value="${cli.direccion || ''}" class="form-control-inline"></td>
            <td id="empleado-cell-${id}">${empleadosSelect}</td>
            <td>
                <button class="btn btn-success btn-sm" onclick="guardarClienteInline('${id}')" style="margin-right: 5px;">
                    <i data-lucide="check"></i>
                </button>
                <button class="btn btn-danger btn-sm" onclick="cargarClientes()">
                    <i data-lucide="x"></i>
                </button>
            </td>
        `;

                lucide.createIcons();
            } catch (error) {
                showAlert('Error al cargar cliente', 'error');
            }
        }

        async function guardarClienteInline(id) {
            // Validar campos
            const nombre = document.getElementById(`edit-nombre-${id}`).value.trim();
            const email = document.getElementById(`edit-email-${id}`).value.trim();

            if (!nombre || !email) {
                showAlert('Nombre y email son obligatorios', 'warning');
                return;
            }

            // Validar formato de email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showAlert('Email inválido', 'warning');
                return;
            }

            // Obtener datos actuales del cliente
            const clienteActual = await fetch(`${API_URL}/usuarios/${id}`).then(r => r.json());

            const usuario = {
                ...clienteActual, // Mantener todos los datos existentes
                nombre: nombre,
                apellido: document.getElementById(`edit-apellido-${id}`).value.trim(),
                email: email,
                telefono: document.getElementById(`edit-telefono-${id}`).value.trim(),
                direccion: document.getElementById(`edit-direccion-${id}`).value.trim()
                // NO incluir password, empleadoAsignadoId - se mantienen o actualizan por separado
            };

            try {
                // Actualizar datos básicos
                await fetch(`${API_URL}/usuarios/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(usuario)
                });

                // Si es admin, actualizar asignación de empleado
                if (currentUserRole === 'ADMINISTRADOR') {
                    const empleadoSelect = document.getElementById(`edit-empleado-${id}`);
                    if (empleadoSelect) {
                        const nuevoEmpleadoId = empleadoSelect.value;

                        // Si cambió el empleado asignado
                        if (clienteActual.empleadoAsignadoId !== nuevoEmpleadoId) {
                            if (nuevoEmpleadoId) {
                                // Asignar nuevo empleado
                                await fetch(`${API_URL}/usuarios/asignar-cliente`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ clienteId: id, empleadoId: nuevoEmpleadoId })
                                });
                            } else {
                                // Desasignar empleado
                                await fetch(`${API_URL}/usuarios/desasignar-cliente`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ clienteId: id })
                                });
                            }
                        }
                    }
                }

                showAlert('Cliente actualizado correctamente', 'success');
                cargarClientes();
            } catch (error) {
                showAlert('Error al actualizar cliente', 'error');
            }
        }

        async function eliminarCliente(id) {
            if (!confirm('¿Está seguro de eliminar este cliente?')) return;

            try {
                await fetch(`${API_URL}/usuarios/${id}`, { method: 'DELETE' });
                showAlert('Cliente eliminado correctamente', 'success');
                cargarClientes();
                loadDashboardData();
            } catch (error) {
                showAlert('Error al eliminar cliente', 'error');
            }
        }

        // GESTIÓN DE USUARIOS
        async function registrarUsuario(e) {
            e.preventDefault();

            // Validación de campos
            const nombre = document.getElementById('usuNombre').value.trim();
            const apellido = document.getElementById('usuApellido').value.trim();
            const email = document.getElementById('usuEmail').value.trim();
            const username = document.getElementById('usuUsername').value.trim();
            const password = document.getElementById('usuPassword').value.trim();

            if (!nombre || !apellido || !email || !username || !password) {
                showAlert('Todos los campos son obligatorios', 'warning');
                return;
            }

            // Validar formato de email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showAlert('Email inválido', 'warning');
                return;
            }

            // Validar longitud de contraseña
            if (password.length < 6) {
                showAlert('La contraseña debe tener al menos 6 caracteres', 'warning');
                return;
            }

            // Validar username (sin espacios)
            if (username.includes(' ')) {
                showAlert('El usuario no puede contener espacios', 'warning');
                return;
            }

            const usuario = {
                nombre: nombre,
                apellido: apellido,
                email: email,
                telefono: document.getElementById('usuTelefono').value.trim(),
                username: username,
                password: password
            };

            const rol = document.getElementById('usuRol').value;
            let endpoint = 'registro-empleado';
            if (rol === 'ADMINISTRADOR') {
                endpoint = 'registro-admin';
            } else if (rol === 'DESPACHO') {
                endpoint = 'registro-despacho';
            }

            try {
                const response = await fetch(`${API_URL}/usuarios/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(usuario)
                });

                const data = await response.json();

                if (data.success) {
                    showAlert(data.mensaje, 'success');
                    e.target.reset();
                    cargarEmpleados();
                } else {
                    showAlert(data.mensaje, 'error');
                }
            } catch (error) {
                showAlert('Error al registrar usuario', 'error');
            }
        }

        async function cargarEmpleados() {
            try {
                const response = await fetch(`${API_URL}/usuarios`);
                const usuarios = await response.json();

                // Filtrar solo empleados y administradores
                const empleadosYAdmins = usuarios.filter(u => u.rol === 'EMPLEADO' || u.rol === 'ADMINISTRADOR' || u.rol === 'DESPACHO');

                const tbody = document.querySelector('#tablaEmpleados tbody');
                tbody.innerHTML = '';

                if (empleadosYAdmins.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 30px; color: #999;">No hay usuarios registrados</td></tr>';
                    return;
                }

                empleadosYAdmins.forEach(emp => {
                    const clientesCount = emp.clientesAsignados ? emp.clientesAsignados.length : 0;
                    const rolBadge = emp.rol === 'ADMINISTRADOR' ?
                        '<span class="badge badge-danger">ADMIN</span>' :
                        '<span class="badge badge-info">EMPLEADO</span>';

                    tbody.innerHTML += `
                <tr id="empleado-row-${emp.id}">
                    <td><strong><span class="view-mode">${emp.nombre} ${emp.apellido || ''}</span></strong> ${rolBadge}</td>
                    <td><span class="view-mode">${emp.email}</span></td>
                    <td><span class="view-mode">${emp.telefono || 'N/A'}</span></td>
                    <td><span class="view-mode">${emp.username}</span></td>
                    <td>${emp.rol === 'EMPLEADO' ? `<span class="badge badge-info">${clientesCount} clientes</span>` : 'Sin asignación'}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editarEmpleadoInline('${emp.id}')" style="margin-right: 5px;">
                            <i data-lucide="edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="eliminarUsuario('${emp.id}')">
                            <i data-lucide="trash-2"></i>
                        </button>
                    </td>
                </tr>
            `;
                });

                lucide.createIcons();
            } catch (error) {
                showAlert('Error al cargar usuarios', 'error');
            }
        }

        async function eliminarUsuario(id) {
            if (!confirm('¿Está seguro de eliminar este usuario?')) return;

            try {
                await fetch(`${API_URL}/usuarios/${id}`, { method: 'DELETE' });
                showAlert('Usuario eliminado', 'success');
                cargarEmpleados();
            } catch (error) {
                showAlert('Error al eliminar usuario', 'error');
            }
        }

        async function editarEmpleadoInline(id) {
            try {
                const response = await fetch(`${API_URL}/usuarios/${id}`);
                const emp = await response.json();

                const row = document.getElementById(`empleado-row-${id}`);
                const clientesCount = emp.clientesAsignados ? emp.clientesAsignados.length : 0;

                row.innerHTML = `
            <td>
                <input type="text" id="edit-emp-nombre-${id}" value="${emp.nombre}" class="form-control-inline" style="width: 100px;">
                <input type="text" id="edit-emp-apellido-${id}" value="${emp.apellido || ''}" class="form-control-inline" style="width: 100px;">
            </td>
            <td><input type="email" id="edit-emp-email-${id}" value="${emp.email}" class="form-control-inline"></td>
            <td><input type="text" id="edit-emp-telefono-${id}" value="${emp.telefono || ''}" class="form-control-inline" style="width: 100px;"></td>
            <td><input type="text" id="edit-emp-username-${id}" value="${emp.username}" class="form-control-inline" style="width: 100px;"></td>
            <td><span class="badge badge-info">${clientesCount} clientes</span></td>
            <td>
                <button class="btn btn-success btn-sm" onclick="guardarEmpleadoInline('${id}')" style="margin-right: 5px;">
                    <i data-lucide="check"></i>
                </button>
                <button class="btn btn-danger btn-sm" onclick="cargarEmpleados()">
                    <i data-lucide="x"></i>
                </button>
            </td>
        `;

                lucide.createIcons();
            } catch (error) {
                showAlert('Error al cargar empleado', 'error');
            }
        }

        async function guardarEmpleadoInline(id) {
            // Primero obtener los datos actuales del empleado
            const empActual = await fetch(`${API_URL}/usuarios/${id}`).then(r => r.json());

            const usuario = {
                ...empActual,
                nombre: document.getElementById(`edit-emp-nombre-${id}`).value,
                apellido: document.getElementById(`edit-emp-apellido-${id}`).value,
                email: document.getElementById(`edit-emp-email-${id}`).value,
                telefono: document.getElementById(`edit-emp-telefono-${id}`).value,
                username: document.getElementById(`edit-emp-username-${id}`).value
            };

            try {
                await fetch(`${API_URL}/usuarios/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(usuario)
                });

                showAlert('Empleado actualizado correctamente', 'success');
                cargarEmpleados();
            } catch (error) {
                showAlert('Error al actualizar empleado', 'error');
            }
        }

        // ALERTAS
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;

            const icon = type === 'success' ? 'check-circle' : 'alert-circle';
            alertDiv.innerHTML = `
                <i data-lucide="${icon}"></i>
                <span>${message}</span>
            `;

            const container = document.getElementById('alertContainer');
            container.innerHTML = '';
            container.appendChild(alertDiv);

            lucide.createIcons();

            setTimeout(() => alertDiv.remove(), 4000);
        }

        // CERRAR SESIÓN
        function logout() {
            if (confirm('¿Cerrar sesión?')) {
                sessionStorage.clear();
                window.location.href = 'login-admin.html';
            }
        }

        // INICIALIZAR
        checkSession();
        lucide.createIcons();
    </script>
</body>

</html>